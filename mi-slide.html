<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">
<link rel="import" href="../neon-animation/neon-animatable.html">
<link rel="import" href="../neon-animation/neon-animations.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<script src="../fabric.js/dist/fabric.js"></script>

<!--
`mi-slide`
Drawing (and sharing) slide as Silvio Meira.

@demo demo/index.html 
-->
<dom-module id="mi-slide">
  <template>
    <style>
      :host {
        position: relative;
        display: block;
        box-sizing: border-box;
        overflow: hidden;
        min-height: 100px;
        cursor: pointer;
      }
      neon-animated-pages {
        position: absolute;
        display: block;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.08);
      }
      .brand {
        display: block;
        position: absolute;
        text-align: center;
        width: 100%;
        height: 100%;
        color: rgba(0,0,0,.30);
        font-size: 2em;
      }
      .brand-table {
        display: table;
        width: 100%;
        height: 100%;        
      }
      .brand-cell {
        display: table-cell;
        vertical-align: middle;
        width: 100%;
      }
      #canvas {
        width: 100%;
        height: 100%;
      }
    </style>
    <div class="content-wrapper">
        <!-- The control of pages will be provided by iron-a11y-keys -->
        <iron-a11y-keys id="a11y" target="[[_target]]" keys="left right" 
        key-bindings="{ 'left': '_onPrevClick', 'right': '_onNextClick'}"></iron-a11y-keys>
        <!-- Pages. A repeat flow based on slides.json -->
        <neon-animated-pages id="pages" selected="[[selected]]" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
          <template is="dom-repeat" items="{{slides}}">
              <neon-animatable>
                <div class="slides-page">
                    <img src="{{item}}">
                </div>
              </neon-animatable>
          </template>
        </neon-animated-pages> 
        <!-- Remove this if necessary -->
        <div class="brand">
          <div class="brand-table">
            <div class="brand-cell">mi-slide</div>
          </div>
        </div>  
        <!-- Canvas overlay -->
        <canvas id="canvas"  width="400" height="400"></canvas>
    </div>
  </template>

  <script>
    Polymer({
      is: 'mi-slide',
      behaviors: [
        Polymer.IronResizableBehavior
      ],
      listeners: {
        // 'tap': '_onNextClick',
        'iron-resize': '_onIronResize'
      },
      properties: {
        /** `slides` slides pages formatted into JSON specs
         * [{'title': 'Abc', 'backgroungImage': 'https://imgae.com/100/100'},...]
         * 
         */
        slides: {
          type: Array,
          value: function(){
            return [];
          },
          observer: "_slidesChanged"
        },
        /** `selected` variable hold the seletec page */
        selected: {
          type: Number,
          value: 0
        },
        /** `_nPages` numbers of pages of the presentation 
         * automatically calculates by numbers of slides in JSON. 
        */
        _nPages: Number,
        /** `_currentPage` current page. 
        */
        _currentPage: Number,        
        /** `_target` main object to listen keys pressed.
         * 
         */
        _target: {
          type: Object,
          value: function() {
            return document.querySelector("body");
          }
        },
        //****************** SETUP CANVAS ************************
        /** `canvas` the canvas wrapper created by Fabric. 
         */        
        canvas: Object,
        /** `colorBrush` brush color can be any regular HTML color 
         * as string.
         */
        colorBrush: {
          type: String,
          value: 'red',
          observer: "_colorBrushChanged"
        },
        /** `widthBrush` this is width of the pencil (point) */
        widthBrush: {
          type: Number,
          value: 3,
          observer: "_widthBrushChanged"
        },
        /** `backgroundColor` sets the background color of the canvas */
        backgroundColor: {
          type: String,
          value: 'rgba(255,255,255,1)' 
        },
        /** TODO: not implemented yet
         * `streamingPoints` array with dots x,y generated 
         * by mouse:move */
        streamingPoints: {
          type: Array,
          value: function(){
            var arr = new Array;
            return arr;
          }
        } 
      },
      ready: function() {
          var elem = this.querySelector("canvas");
          // HINT for random numbers based on:
          // https://github.com/rwth-acis/drawing-overlay/blob/master/drawing-overlay.html
          // elem.id += Math.floor((Math.random() * 100) + 1);
          // this.canvasid = elem.id; 
          this.initialize("canvas");
      },
      _counterPages: function() {
        var pages = this.querySelectorAll("neon-animatable");
        return pages.length;
      },
      _slidesChanged: function(){
        this.async(function(){
          this._nPages = this._counterPages();
        }, 300);
      },
      /** `initialize` setup of the fabric.js where controls and borders
       *  is disabled. The isDrawingMode is configured to true.
       * 
       * @referenceId[String]: hold canvas id attribute value used as
       * selector.
       */
      initialize: function(referenceId) {
          // 
          var self = this;
          // create instance
          this.canvas = new fabric.Canvas(referenceId);
          // listening changes
          this.canvas.on('path:created', function(obj){
              var lastOrder = self.canvas._objects.length - 1;
              var lastObj = self.canvas._objects[lastOrder];
              self.locker(lastObj);
              self.noBorderAndControls(lastObj);
              self._fireToJSON();
          });
          // streaming point-to-point 
          this.canvas.on('mouse:down', function(obj){
              self.canvas.on('mouse:move', self._moveHandler);              
          });
          this.canvas.on('mouse:up', function(obj){
              self.canvas.off('mouse:move', self._moveHandler);  
          });           
          // activate drawing mode.
          this.canvas.isDrawingMode = true;
          // brush setup
          this._colorBrushChanged();
          this._widthBrushChanged();
      },
      /** `locker` locks horizontal and vertical move, rotation 
       * and scaling properties of a fabric.Path.
       * 
       * @obj: is a fabric.Path (fabric's object)
      */
      locker: function(obj){
          obj.lockMovementX = true;
          obj.lockMovementY = true;
          obj.lockRotation = true;
          obj.lockScaling = true;
      },
      /** `noBorderAndControls` hide bordes and controls of the object. 
       * 
       * @obj: is a fabric.Path (fabric's object) 
      */
      noBorderAndControls: function(obj) {
          obj.hasControls = false;
          obj.hasBorders = false;
      },
      _colorBrushChanged: function() {
          if (this.canvas)
              this.canvas.freeDrawingBrush.color = this.colorBrush; 
      },
      _widthBrushChanged: function() {
          if (this.canvas)
              this.canvas.freeDrawingBrush.width = this.widthBrush;
      },
      /** `_onPrevClick` transition when left key pressed */
      _onPrevClick: function() {
        this.entryAnimation = 'slide-from-left-animation';
        this.exitAnimation = 'slide-right-animation';
        this.selected = this.selected === 0 ? this._nPages - 1 : (this.selected - 1);
      },
      /** `_onNextClick` transition when right key pressed */
      _onNextClick: function() {
        this.entryAnimation = 'slide-from-right-animation';
        this.exitAnimation = 'slide-left-animation';
        this.selected = this.selected === this._nPages - 1 ? 0 : (this.selected + 1);
      },
      /** `_onUpClick` transition when key up pressed */
      _onUpClick: function() {
        this.entryAnimation = 'slide-from-top-animation';
        this.exitAnimation = 'slide-down-animation';
        this.selected = this.selected === this._nPages - 1 ? 0 : (this.selected + 1);
      },
      /** `_onDownClick` transition when key down pressed */
      _onDownClick: function() {
        this.entryAnimation = 'slide-from-bottom-animation';
        this.exitAnimation = 'slide-up-animation';
        this.selected = this.selected === 0 ? this._nPages - 1 : (this.selected - 1);
      },
      _onIronResize: function(){
          console.log("resize done");
          var canvas = this.$.canvas;
          var canvasUp = this.querySelector('.upper-canvas');
          // original canvasl
          canvas.width = this.offsetWidth;
          canvas.height = this.offsetHeight;
          canvas.style.width = canvas.width + 'px';
          canvas.style.height = canvas.height + 'px';
          // fabric upper-canvas
          canvasUp.width = this.offsetWidth;
          canvasUp.height = this.offsetHeight;          
          canvasUp.style.width = canvas.width + 'px';
          canvasUp.style.height = canvas.height + 'px';
          // fabric's instance canvas
          this.canvas.width = canvas.width;
          this.canvas.height = canvas.height;
          // reset
          this.canvas.renderAll();
      },
      /** TODO: not implemented yet
       * `_moveHandler` get x,y from mouse:move and create streaming
       * for update drawing in the remote view.
       */
      _moveHandler: function(obj){
          var mi = document.querySelector('mi-slide');  
          mi.streamingPoints.push([obj.e.x, obj.e.y]);
      },
      /** `_fireToJSON` fire events with JSON values
       * 
       */
      _fireToJSON: function(){
          var d = this.canvas.toJSON();
          this.fire('mi-slide:json', {dump: d});
      }                    
    });
  </script>
</dom-module>

